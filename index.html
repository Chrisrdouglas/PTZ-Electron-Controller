<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Chris' $50 Controller</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <h1>Chris' $50 Controller</h1>
    <div class='ControlPanel'>
        <div class='CameraControlContainer'>
            <div class='CameraView'>
                <img id="camera" src="" border="5px" width="680" height="400">

            </div>
            <div class='Controls'>
                <div class='threeColumn'>
                    <button class='Button PowerButton PowerButtonOff' id='powerButton' value='off'
                        onclick="cameraPowerChange()" onmouseover="cameraPowerState()">POWER</button>
                </div>
                <div class='threeColumn'>
                    <div class='twoColumn'>
                        <button class='Button ControllerButton ControllerButtonUnpressed' id='CButton'
                            disabled>C</button>
                        <button class='Button ControllerButton ControllerButtonUnpressed' id='ZButton'
                            disabled>Z</button>
                    </div>
                    <div class='ControlStickDisplay'>
                        <div class='OutsideBox' id='outsideBox'>
                            <span class="dot" id='redDot'></span>
                            <div class='InsideBox'></div>
                        </div>

                    </div>
                </div>
                <div class='threeColumn'><select class='comSelector'>Com Selector</select></div>
            </div>
        </div>
        <div class='ZoomBar'></div>
    </div>
    <script>
        var config = require('./configure.json');
        var camConfig = require('./' + config['cameraType'] + '.json')
        var x = config['lastX'];
        var y = config['lastY'];
        var IP = config['cameraIP'];
        var zoomState = false;
        var camMoveState = false;


        //const electron = require('electron');
        //const {ipcRenderer} = electron;
        const fs = require('fs');
        const SerialPort = require('serialport');
        const Readline = require('@serialport/parser-readline');
        var port = new SerialPort(config["controllerComPort"]);
        const parser = port.pipe(new Readline({ delimiter: '\n' }));

        //important references
        var redDot = document.getElementById('redDot');
        var zbutton = document.getElementById('ZButton');
        var outsideBox = document.getElementById('outsideBox');
        var cbutton = document.getElementById('CButton');

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        function cameraPowerState() {
            //http://192.168.86.228/cgi-bin/aw_ptz?cmd=%23O&res=1
            const http = new XMLHttpRequest();
            var url = (camConfig['cameraCommandURL'].replace('{IP}', config['cameraIP'])).replace('{Command}', camConfig['commands']['powerState']);
            //'http://' + IP + '/cgi-bin/aw_ptz?cmd=%23O&res=1';
            http.open("GET", url);
            http.send();
            http.onreadystatechange = (e) => {
                var powerButton = document.getElementById('powerButton');
                if (http.responseText == 'p1' && powerButton.classList.contains('PowerButtonOff')) {
                    powerButton.classList.replace('PowerButtonOff', 'PowerButtonOn');
                    powerButton.value = "on"
                    var image = document.getElementById('camera');
                    image.src = (camConfig['cameraVideoFeed']).replace('{IP}', config['cameraIP']);
                }
                else if (http.responseText == 'p0' && powerButton.classList.contains('PowerButtonOn')) {
                    powerButton.classList.replace('PowerButtonOn', 'PowerButtonOff');
                    powerButton.value = 'off'
                }
            }
        }

        function cameraPowerChange() {
            var powerButton = document.getElementById('powerButton');
            if (powerButton.value == 'on') {
                var url = camConfig['cameraCommandURL'].replace("{IP}", config['cameraIP']).replace("{Command}", camConfig['commands']['powerControls']['off']);
                //'http://' + IP + '/cgi-bin/aw_ptz?cmd=%23Of&res=1';
                //confirm that we want to turn camera off
                var r = confirm("Are you sure that you'd like to turn off the camera?");
                if (r == false) {
                    return
                }
            }
            else {
                var url = camConfig['cameraCommandURL'].replace("{IP}", config['cameraIP']).replace("{Command}", camConfig['commands']['powerControls']['on']);
            }
            const http = new XMLHttpRequest();
            http.open("GET", url);
            http.send();
            http.onreadystatechange = (e) => {
                //sleep(1000); // why isn't this working when i turn on the camera????
                cameraPowerState();
            }
        }

        function updateControllerInfo(controllerState) {
            //console.log(controllerState)
            var obj = JSON.parse(controllerState);

            if (obj['Buttons'].includes('C')) {
                if (cbutton.classList.contains('ControllerButtonUnpressed')) {
                    cbutton.classList.remove('ControllerButtonUnpressed');
                    cbutton.classList.add('ControllerButtonPressed');
                }
                x = obj['Joystick']['X'];
                y = obj['Joystick']['Y'];

                //write to config file
                config['lastX'] = x;
                config['lastY'] = y;

                try { fs.writeFileSync('./configure.json', JSON.stringify(config), 'utf-8'); }
                catch (e) { console.log(e); }

            }
            else {
                if (cbutton.classList.contains('ControllerButtonPressed')) {
                    cbutton.classList.remove('ControllerButtonPressed');
                    cbutton.classList.add('ControllerButtonUnpressed');
                }
            }


            if (obj['Buttons'].includes('Z')) {
                if (zbutton.classList.contains('ControllerButtonUnpressed')) {
                    zbutton.classList.remove('ControllerButtonUnpressed');
                    zbutton.classList.add('ControllerButtonPressed');
                }
                //add code here for zoom
                zoom(obj['Joystick']['Y']);
            }
            else {
                if (zbutton.classList.contains('ControllerButtonPressed')) {
                    zbutton.classList.remove('ControllerButtonPressed');
                    zbutton.classList.add('ControllerButtonUnpressed');
                }
                if (zoomState == true){
                    zoom(y);
                }
            }

            //update joystick position on screen
            //console.log(obj['Joystick']['X']);
            var newX = ((obj['Joystick']['X'] / (x * 2)) * outsideBox.clientWidth) - 12.5;
            var newY = ((obj['Joystick']['Y'] / (y * 2)) * outsideBox.clientHeight) - 12.5;
            //console.log(newX)
            redDot.style.top = (outsideBox.clientHeight - 25 - newY) + "px";
            redDot.style.left = newX + "px";
            if (obj['Buttons'].length == 0){
                moveCamera(obj['Joystick']);
            }
                
        }

        function zoom(yStick) {
            if (yStick == y){
                zoomState = false;
            }
            else{
                zoomState = true;
            }
            var percentage = yStick / (2 * y);
            var zoomChoice = Math.floor(percentage * camConfig['commands']['zoomSpeed'].length);
            sendZoomCommand(camConfig['commands']['zoomSpeed'][zoomChoice]);
        }

        function sendZoomCommand(speedChoice) {
            console.log(speedChoice);
            var url = camConfig['cameraCommandURL'].replace('{IP}', config['cameraIP']).replace('{Command}', speedChoice);
            const http = new XMLHttpRequest();
            http.open("GET", url);
            http.send();
            http.onreadystatechange = (e) => {
                //sleep(1000); // why isn't this working when i turn on the camera????
                //cameraPowerState();
            }
        }

        function moveCamera(xy) {
            if(xy['X'] == x && xy['Y'] == y){
                if (camMoveState == true){
                    camMoveState = false;
                    sendMoveCommand("5050");
                }
                return;
            }
            camMoveState = true;
            //commandX = ;
            //commandY = ;
            //console.log("XCommand: "+ commandX + ", X: " + xy['X']);
            //console.log("YCommand: "+ commandY + ", Y: " + xy['Y']);
            sendMoveCommand(padNum(calculateStickRange(xy['X'], x), 2)+ padNum(calculateStickRange(xy['Y'], y), 2));
            return;
        }

        function sendMoveCommand(speedChoice){
            console.log(speedChoice);
            var command = camConfig['commands']['cameraPanTilt'] + speedChoice;
            var url = camConfig['cameraCommandURL'].replace('{IP}', config['cameraIP']).replace('{Command}', command);
            const http = new XMLHttpRequest();
            http.open("GET", url);
            http.send();
        }

        function padNum(num, size){

            num = num.toString();
            while(num.length < size){
                console.log(num)
                num = '0' + num;
            }
            return num;
        }

        function calculateStickRange(stick, mean){
            commandX = Math.floor(stick/(2*mean)*100);
            console.log(commandX);
            if (commandX <= 0){
                return 1;
            }
            console.log(commandX);
            if(commandX >= 100){
                return 99;
            }
            //console.log(commandX);
            return commandX;
        }

        function setAutoFocus(tf) {
            if (tf) {
                var url = camConfig['cameraCommandURL'].replace('{IP}', config['cameraIP']).replace('{Command}', camConfig['commands']['autoFocus']['on']);
            }
            else {
                var url = camConfig['cameraCommandURL'].replace('{IP}', config['cameraIP']).replace('{Command}', camConfig['commands']['autoFocus']['on']);
            }
            const http = new XMLHttpRequest();
            http.open("GET", url);
            http.send();
        }

        setAutoFocus(config['defaultAutoFocus']);
        setInterval(cameraPowerState, 1000);
        parser.on('data', updateControllerInfo);




        window.addEventListener('DOMContentLoaded', () => {
            const replaceText = (selector, text) => {
                const element = document.getElementById(selector)
                if (element) element.innerText = text
            }

            for (const type of ['chrome', 'node', 'electron']) {
                replaceText(`${type}-version`, process.versions[type])
            }
        })
    </script>
</body>

</html>